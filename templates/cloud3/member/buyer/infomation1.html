<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>个人资料-会员中心-{C('WEBNAME')}</title>
<meta name="Keywords" content="个人资料,会员中心,{C('WEBNAME')}" />
<meta name="Description" content="个人资料,会员中心,{C('WEBNAME')}" />
<link rel="stylesheet" href="{THEME_STYLE_PATH}style/css/style.css" />
<link rel="stylesheet" href="{THEME_STYLE_PATH}style/css/shops_vip_style.css" />
<link rel="stylesheet" href="{THEME_STYLE_PATH}style/css/personal_member_data.css" />
<script type="text/javascript" src="{THEME_STYLE_PATH}style/js/Move.js"></script>
<script type="text/javascript" src="{THEME_STYLE_PATH}style/js/setIndex.js"></script>
<!-- <script type="text/javascript" src="{THEME_STYLE_PATH}style/js/jquery-1.9.1.min.js"></script> -->
<script language="javascript" type="text/javascript" src="{JS_PATH}jquery.min.js"></script>
<script language="javascript" type="text/javascript" src="<?php echo JS_PATH?>formvalidator.js" charset="UTF-8"></script>
<script language="javascript" type="text/javascript" src="<?php echo JS_PATH?>formvalidatorregex.js" charset="UTF-8"></script>
<script type="text/javascript" src="{THEME_STYLE_PATH}style/js/slide.js"></script>
<script type="text/javascript">
	$(document).ready(function(){
		//首页顶部移入效果
		setTopMouseover();	
		/* $("#loading").ajaxStart(function(){
			$("#avatar").hide();
            $(this).show();
         }).ajaxComplete(function(){
            $(this).hide();
            $("#avatar").show();
         }); */
		
	$(".image").click(function (){
		$("#file_upload").click();
	});
	$(".add_receiving_address_ico").click(function(){
		$(this).siblings("div").show();
	});
	});

</script>
<style type="text/css">
	.onShow,.onFocus,.onError,.onCorrect,.onLoad,.onTime{display:inline-block;display:-moz-inline-stack;zoom:1;*display:inline; vertical-align:middle;background:url({IMG_PATH}msg_bg.png) no-repeat;	color:#444;line-height:18px;padding:2px 10px 2px 23px; margin-left:10px;_margin-left:5px}
	.onShow{background-position:3px -147px;border-color:#40B3FF;color:#959595}
	.onFocus{background-position:3px -147px;border-color:#40B3FF;}
	.onError{background-position:3px -47px;border-color:#40B3FF; color:red}
	.onCorrect{background-position:3px -247px;border-color:#40B3FF;}
	.onLamp{background-position:3px -200px}
	.onTime{background-position:3px -1356px}
</style>
<script type="text/javascript">
	$(function(){
		$.formValidator.initConfig({
		formid:"myform",
		autotip:true,
		onerror:function(msg,obj){
			$(obj).focus();
		}
		});
		/* 用户名昵称 */
		{if empty($userinfo[nickname])}
		$("#nickname").formValidator({
			empty:false,
			onempty:'用户昵称不能为空',
			onshow:'请输入用户昵称',
			onfocus:'请输入用户昵称'
		}).functionValidator({
			fun:function(val,elem){
				if(val.length < 2 || val.length >20){
					return '请输入2-20个字符，使用字母数字加上下划线';
				}
				return true;
			}
		}).regexValidator({
			regexp:'ps_username',
			datatype:'enum',
			onerror:'用户名只能是数字或字母'
		})
		{else}
		$("#nickname").formValidator({
			empty:false,
			onempty:'用户昵称不能为空',
			onshow:'请输入用户昵称',
			onfocus:'请输入用户昵称'
		}).functionValidator({
			fun:function(val,elem){
				if(val.length < 2 || val.length >20){
					return '请输入2-20个字符，使用字母数字加上下划线';
				}
				return true;
			}
		}).regexValidator({
			regexp:'ps_username',
			datatype:'enum',
			onerror:'用户名只能是数字或字母'
		}).defaultPassed();
		{/if}
		
		/*收货地址*/
		{if empty($r_address)}
		$("#r_address").formValidator({
			empty:false,
			onempty:'收货地址不能为空',
			onshow:'请输入收货地址',
			onfocus:'请输入收货地址'
		}).inputValidator({
			min:2,
			max:100,
			onerror:'收货地址字符为2到100个字符' 
		});
		{else}
		$("#r_address").formValidator({
			empty:false,
			onempty:'收货地址不能为空',
			onshow:'请输入收货地址',
			onfocus:'请输入收货地址'
		}).inputValidator({
			min:2,
			max:100,
			onerror:'收货地址字符为2到100个字符' 
		}).defaultPassed();
		{/if}
		/*收货人*/
		{if empty($r_name)}
		$("#r_name").formValidator({
			empty:false,
			onempty:'收货人不能为空',
			onshow:'请输入收货人',
			onfocus:'请输入收货人'
		}).inputValidator({
			min:2,
			max:20,
			onerror:'收货人字符为2到20个字符' 
		});
		{else}
		$("#r_name").formValidator({
			empty:false,
			onempty:'收货人不能为空',
			onshow:'请输入收货人',
			onfocus:'请输入收货人'
		}).inputValidator({
			min:2,
			max:20,
			onerror:'收货人字符为2到20个字符' 
		}).defaultPassed();
		{/if}


		/*联系qq*/
		{if empty($userinfo['qq'])}
		$("#qq").formValidator({
			empty:false,
			onempty:'联系qq不能为空',
			onshow:'请输入联系qq',
			onfocus:'请输入联系qq'
		}).regexValidator({
			regexp:'qq',
			datatype:'enum',
			onerror:'联系qq输入错误'
		});
		{else}
		$("#qq").formValidator({
			empty:false,
			onempty:'联系qq不能为空',
			onshow:'请输入联系qq',
			onfocus:'请输入联系qq'
		}).regexValidator({
			regexp:'qq',
			datatype:'enum',
			onerror:'联系qq输入错误'
		}).defaultPassed();
		{/if}	
		/*联系电话*/
		{if empty($r_phone)}
		$("#r_phone").formValidator({
			empty:false,
			onempty:'联系电话不能为空',
			onshow:'请输入联系电话',
			onfocus:'请输入联系电话'
		}).regexValidator({
			regexp:'mobile',
			datatype:'enum',
			onerror:'联系电话输入错误'
		});
		{else}
		$("#r_phone").formValidator({
			empty:false,
			onempty:'联系电话不能为空',
			onshow:'请输入联系电话',
			onfocus:'请输入联系电话'
		}).regexValidator({
			regexp:'mobile',
			datatype:'enum',
			onerror:'联系电话输入错误'
		}).defaultPassed();
		{/if}	
	})
</script>
</head>
<body>

<!-- wrap 内容页盒模型 -->
{include template('toper','common')}
	{include template('header','member/common')}

	<div class="content">
		<div class="content_wrap overflow_hidden">
<div class="nav_path">
		<a href="{__APP__}">首页</a>&nbsp;>
		<a href="{U('Member/Profile/index')}" class="nav_active">个人中心</a>&nbsp;>
		<a href="{U('Member/Profile/infomation')}" class="nav_active">个人资料</a>
</div>

			{include template("member_left","member/common")}
			<div class="content_right float_right">
				<h1 class="float_left">个人资料</h1>
				<div class="float_right editor_data">编辑资料</div>
				<div style="clear:both;"></div>
				<form action="{U('Member/Profile/infomation')}" method="post" id="myform">
				<div class="personal_data">
					<div class="personal_data_data float_left">
						<dl>
							<dt class="float_left">昵称：</dt>
							<dd class="float_left"><input type="text" id="nickname" name="nickname" value="{$userinfo[nickname]}" class="h27 pl10 w108 c999999" /></dd>
						</dl>
						<div style="clear:both;"></div>
						<dl>
							<dt class="float_left">性别：</dt>
							<dd class="float_left sex">
								<span><input type="radio" name="sex" value="2" {if $sex == '2'}checked="checked"{/if}/></span>
								<span>男</span>&nbsp; 
								<span><input type="radio" name="sex" {if $sex == '1'}checked="checked"{/if} value="1" /></span>
								<span>女</span>&nbsp;
								<span><input type="radio" name="sex" {if !$sex}checked="checked"{/if} value="0" /></span>
								<span>保密</span>
							</dd>
						</dl>
						<div style="clear:both;"></div>
						<dl>
							<dt class="float_left">生日：</dt>
							<dd class="float_left">
								<select name="year" id="year" class="c999999" onchange="getDates()" >
									<script language="javascript" type="text/javascript"> 
										var date=new Date(); 
										var year=date.getFullYear();
										var years = "<?php echo $year; ?>";
										for(var i=year;i>=year-50;i--){ 
											if (years != '') {
												if (i == years) {
													document.write("<option value="+years+" selected>"+years+"</option>"); 
												}else{
													document.write("<option value="+i+">"+i+"</option>"); 
												}
											}else{
											document.write("<option value="+i+">"+i+"</option>"); 
											}
										} 
										function append(o,v){ 

										var option=new Option(v,v); 
										o.options.add(option); 
										}
										function getDates(){
										var y=document.getElementsByName("year")[0].value; 
										var m=document.getElementsByName("month")[0].value;
										var day=document.getElementsByName("day")[0]; 
										day.innerHTML="";
										if(m==1 || m==3 || m==5 || m==7 || m==8 || m==10 || m==12){ 
										for(var j=1;j<=31;j++){ 
										append(day,j); 
										} 
										} 
										else if(m==4 || m==6 || m==9 || m==11){ 
										for(var j=1;j<=30;j++){ 
										append(day,j); 
										} 
										} 
										else if(m==2){ 
										var flag=true; 
										flag=y%4==0&&y%100!=0||y%400==0; 
										if(flag){ 
										for(var j=1;j<=29;j++){ 
										append(day,j); 
										} 
										} 
										else{ 
										for(var j=1;j<=28;j++){ 
										append(day,j); 
										} 
										} 
										}
										} 
										</script> 
								</select>
								<select name="month" class="c999999" onchange="getDates()" >
								<script language="javascript" type="text/javascript">
										var month = "<?php echo $month; ?>";
										for(var i=1;i<=12;i++){ 
											if (month != '') {
											if (i == month) {
												document.write("<option value="+month+" selected>"+month+"</option>"); 
											}else{
												document.write("<option value="+i+">"+i+"</option>"); 
											};

										}else{
											document.write("<option value="+i+">"+i+"</option>"); 

											}
										} 
									</script>
								</select>
								<select name="day" class="c999999">
									<script language="javascript" type="text/javascript">
										var day = "<?php echo $day; ?>";
										for(var i=1;i<=31;i++){ 
											if (day != '') {
											if (i == day) {
												document.write("<option value="+day+" selected>"+day+"</option>"); 
											}else{
												document.write("<option value="+i+">"+i+"</option>"); 
											}

										}else{
												document.write("<option value="+i+">"+i+"</option>"); 
										}
											
										} 
									</script>
								</select>
							</dd>
						</dl>
						<div style="clear:both;"></div>
						<script type="text/javascript">
							$(document).ready(function(){
								//查询省市
								$("#province").change(function(){
									$("#city").remove();
									var _this = $(this).val();
									$.ajax({
										url:'{U('Member/Profile/get_area')}',
										type:'post',
										dataType:'json',
										data:{'id':_this},
										success:function(data){
											var html = '';
											html += '&nbsp;<select name="city" class="c999999" id="city">';
											$.each(data ,function(i,item){
												html += '<option value="'+item.linkageid+'">'+item.name+'</option>';
											});
											html += '</select>';
											$("#province").after(html);
										}
									});
								});
								//查询城镇
								$(document).on('change','#city',function(){
									$("#area").remove();
									var _this = $(this).val();
									$.ajax({
										url:'{U('Member/Profile/get_area')}',
										type:'post',
										dataType:'json',
										data:{'id':_this},
										success:function(data){
											var html = '';
											html += '&nbsp;<select name="area" class="c999999" id="area">';
											$.each(data ,function(i,item){
												html += '<option value="'+item.linkageid+'">'+item.name+'</option>';
											});
											html += '</select>';
											$("#city").after(html);
										}
									});
								});
								
								//默认地址 取得选中的省市id
								var city = "<?php echo $city;?>"; 
								var proid = $("#province").find("option:selected").val();
								$.ajax({
									url:'{U('Member/Profile/get_area')}',
									type:'post',
									dataType:'json',
									data:{'id':proid},
									success:function(data){
										var html = '';
										html += '&nbsp;<select name="city" class="c999999" id="city">';
										$.each(data ,function(i,item){
											if(item.linkageid == city){
												html += '<option value="'+item.linkageid+'" selected>'+item.name+'</option>';
											}else{
												html += '<option value="'+item.linkageid+'">'+item.name+'</option>';
											}
										});
										html += '</select>';
										$("#province").after(html);
									}
								});
								//alert(city);
								//默认的乡镇
								$.ajax({
									url:'{U('Member/Profile/get_area')}',
									type:'post',
									dataType:'json',
									data:{'id':city},
									success:function(data){
										var html = '';
										html += '&nbsp;<select name="area" class="c999999" id="area">';
										var area = "<?php echo $area;?>";//乡镇
										$.each(data ,function(i,item){
											if(item.linkageid == area){
												html += '<option value="'+item.linkageid+'" selected>'+item.name+'</option>';
											}else{
												html += '<option value="'+item.linkageid+'">'+item.name+'</option>';
											}
										});
										html += '</select>';
										$("#city").after(html);
									}
								});
							});						
						</script>
						<dl>
							<dt class="float_left">所在地：</dt>
							<dd class="float_left" id="address">
								<select name="province" class="c999999" id="province">
									<option value="-1">请选择</option>
									{loop $region $v}
									<option {if $v['linkageid'] == $provice}selected{/if} value="{$v['linkageid']}">{$v['name']}</option>
									{/loop}
								</select>
							</dd>
						</dl>
						<div style="clear:both;"></div>
						<dl>
							<dt class="float_left">收货地址：</dt>
							<dd class="float_left"><input type="text" id="r_address" name="receives[r_address]" value="{$r_address}" class="h27 pl10 w283 c999999"/></dd>
						</dl>
						<div style="clear:both;"></div>
						<dl>
							<dt class="float_left">收货人：</dt>
							<dd class="float_left"><input type="text" id="r_name" name="receives[r_name]" value="{$r_name}" class="h27 pl10 w283 c999999"/></dd>
						</dl>
						<div style="clear:both;"></div>
						<dl>
							<dt class="float_left">联系QQ：</dt>
							<dd class="float_left"><input type="text"  id="qq" name="qq" value="{$userinfo[qq]}" class="h27 pl10 w283 c999999"/></dd>
						</dl>
						<div style="clear:both;"></div>
						<dl>
							<dt class="float_left">联系电话：</dt>
							<dd class="float_left"><input type="text"  id="r_phone" name="receives[r_phone]" value="{$r_phone}" class="h27 pl10 w283 c999999"/></dd>
						</dl>
						
					</div>
					<div class="float_right personal_data_avatar" id="goods_albums">
						<span class="portrait" id="img1"> 
							<img src="<?php echo $this->userinfo['avatar'];?>" width="100" height="100"/>
							<img id="loading" src="{THEME_STYLE_PATH}style/images/loading.gif" style="display:none;width:100px;height:100px;" />
							<input type="hidden" id="file_url" name="avatar"  value=""/>
						</span>
						<span><a href="javascript:;" class="image" >修改头像</a></span>
					</div>
				</div>

				<div style="clear:both;"></div>
				<div class="data_submit">
					<input type="submit" name="sub" value="保存" class="save" />
				</div>
				</form>
			</div>
		</div>
	</div>
		{include template("footer","common")}
</body>
<link href="{JS_PATH}webuploader/webuploader.css" rel="stylesheet" /> 
<script src="{JS_PATH}webuploader/webuploader.js" type="text/javascript"></script>
<script type="text/javascript">
//图片上传功能
$(document).ready(function() {
	var goods_album = $("#goods_albums").find('span');
	for(var i=0; i < goods_album.length; i++) {
		var uploader = WebUploader.create({
			auto:true,
			fileVal:'Filedata',
		    // swf文件路径
		    swf: '{JS_PATH}webuploader/webuploader.swf',
		    // 文件接收服务端。
		    server: "{U('Attachment/Attachment/swfupload')}",
		    // 选择文件的按钮。可选
		    formData:{
		    	"module":"",
		    	"catid":"",
		    	"userid":"1",
		    	"dosubmit":"1",
		    	"thumb_width":"0",
		    	"thumb_height":"0",
		    	"watermark_enable":"1",
		    	"filetype_post":"jpg|jpeg|gif|bmp|png",
		    	"swf_auth_key":"57a39f6f7415ec2cdd2b8afd77b57c3f",
		    	"isadmin":"1",
		    	"groupid":"2"
		    },
		    // 内部根据当前运行是创建，可能是input元素，也可能是flash.
		    pick: {
		    	id: '#img' + (i+1),
		    	multiple:false
		    },
		    accept:{
				title: '图片文件',
				extensions: 'gif,jpg,jpeg,bmp,png',
				mimeTypes: 'image/*'
		    },
		    thumb:{
		    	width: '110',
		    	height: '110'
		    },
		    chunked: false,
		    chunkSize:1000000,
		    // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
		    resize: false
		});

		uploader.onUploadSuccess = function( file, response ) {
			var pickid = this.options.pick.id;
			var data = response._raw;
			var arr = data.split(',');
			if(arr[0] > 0) {
				$(pickid).find('img').attr('src', arr[1]);
				$(pickid).find('input[type=hidden]').eq(0).attr('value', arr[1]);
			}

			$.post("{U('Member/profile/update_avatar')}",{
                    avatar:arr[1]
                },function(data){
                    //location.reload();
                },'json')
		}

		uploader.onUploadError = function(file, reason) {
			alert('文件上传错误：' + reason);
		}
	}
})
</script>
</html>